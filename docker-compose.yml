# ==============================================================================
# Docker Compose - Django Multi-tenant avec PostgreSQL
# Version production-ready avec healthchecks, volumes et réseaux séparés
# ==============================================================================

version: '3.9'

# ==============================================================================
# RÉSEAUX
# ==============================================================================
networks:
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  
  frontend:
    driver: bridge

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  postgres_data:
    driver: local
  
  static_volume:
    driver: local
  
  media_volume:
    driver: local
  
  logs_volume:
    driver: local

# ==============================================================================
# ANCRES YAML (pour éviter la duplication)
# ==============================================================================
x-backend-environment: &backend-environment
  DJANGO_SETTINGS_MODULE: complaintsManager.settings
  DB_NAME: ${DB_NAME:-complaints}
  DB_USER: ${DB_USER:-postgres}
  DB_PASSWORD: ${DB_PASSWORD:-28062004}
  DB_HOST: db
  DB_PORT: 5432

# ==============================================================================
# SERVICES
# ==============================================================================
services:
  # ----------------------------------------------------------------------------
  # PostgreSQL - Base de données
  # ----------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    container_name: complaints_db
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: ${DB_NAME:-complaints}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-28062004}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    
    networks:
      - backend
    
    #ports:
      #- "${DB_PORT:-5432}:5432"
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-complaints}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c log_statement=mod
      -c log_duration=off
      -c log_line_prefix='%%t [%%p]: [%%l-1] user=%%u,db=%%d,app=%%a,client=%%h '

  # ----------------------------------------------------------------------------
  # Django Backend
  # ----------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE:-2025-01-01}
        - VCS_REF=${VCS_REF:-main}
    
    container_name: complaints_backend
    restart: unless-stopped
    
    depends_on:
      db:
        condition: service_healthy
    
    environment:
      # Django
      DJANGO_SETTINGS_MODULE: complaintsManager.settings
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      
      # Database
      DB_NAME: ${DB_NAME:-complaints}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-28062004}
      DB_HOST: db
      DB_PORT: 5432
      
      # Superuser
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL:-admin@example.com}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD:-supermotdepasse}
      DJANGO_SUPERUSER_NAME: ${DJANGO_SUPERUSER_NAME:-Super Admin}
      CREATE_SUPERUSER: ${CREATE_SUPERUSER:-true}
      
      # Static/Media
      STATIC_ROOT: /app/staticfiles
      MEDIA_ROOT: /app/mediafiles
      COLLECT_STATIC: ${COLLECT_STATIC:-true}
      
      # Gunicorn
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-4}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-2}
      
      # Multi-tenant
      PUBLIC_DOMAIN: ${PUBLIC_DOMAIN:-localhost}
      
      # Security
      CORS_ALLOW_ALL_ORIGINS: ${CORS_ALLOW_ALL_ORIGINS:-False}
      CSRF_TRUSTED_ORIGINS: "http://localhost:3000,http://localhost:8000"
      
      # Email (optionnel)
      # EMAIL_BACKEND: ${EMAIL_BACKEND:-django.core.mail.backends.console.EmailBackend}
      # EMAIL_HOST: ${EMAIL_HOST:-}
      # EMAIL_PORT: ${EMAIL_PORT:-587}
      # EMAIL_USE_TLS: ${EMAIL_USE_TLS:-True}
      # EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      # EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
    
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/mediafiles
      - logs_volume:/app/logs
      # Pour le développement, monter le code en live
      # - .:/app
    
    networks:
      - backend
      - frontend
    
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ----------------------------------------------------------------------------
  # Nginx - Reverse Proxy (Optionnel mais recommandé pour la prod)
  # ----------------------------------------------------------------------------
  # nginx:
    # image: nginx:alpine
    # container_name: complaints_nginx
    # ports:
      # - "80:80"
    # volumes:
      # - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # - static_volume:/static
      # - media_volume:/media
    # depends_on:
      # - backend
    # networks:
      # - backend
    # healthcheck:
      # test: ["CMD", "wget", "-qO-", "http://localhost/health"]
      # interval: 10s
      # timeout: 3s
      # retries: 5



  # ----------------------------------------------------------------------------
  # Redis - Cache et Celery (Optionnel)
  # ----------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: complaints_redis
    restart: unless-stopped
    
    command: >
      redis-server
      --appendonly yes
      --appendfilename "appendonly.aof"
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    
    volumes:
      - ./redis-data:/data
    
    networks:
      - backend
    
    ports:
      - "${REDIS_PORT:-6379}:6379"
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    profiles:
      - full  # Activer avec: docker-compose --profile full up

  # ----------------------------------------------------------------------------
  # Celery Worker (Optionnel)
  # ----------------------------------------------------------------------------
  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: complaints_celery_worker
    restart: unless-stopped
    
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    environment:
      <<: *backend-environment
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    
    volumes:
      - media_volume:/app/mediafiles
      - logs_volume:/app/logs
    
    networks:
      - backend
    
    command: celery -A complaintsManager worker --loglevel=info --concurrency=2
    
    profiles:
      - full

  # ----------------------------------------------------------------------------
  # Celery Beat (Optionnel - Tâches planifiées)
  # ----------------------------------------------------------------------------
  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: complaints_celery_beat
    restart: unless-stopped
    
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    environment:
      <<: *backend-environment
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    
    volumes:
      - logs_volume:/app/logs
    
    networks:
      - backend
    
    command: celery -A complaintsManager beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    
    profiles:
      - full